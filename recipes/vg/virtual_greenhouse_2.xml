<?xml version="1.0" encoding="ISO-8859-1"?>
<simulation name="Virtual Greenhouse">

    <integrator name="steps" type="UniSim::Steps">
		<parameter name="maxSteps"  value="5760" />
	</integrator>

	<model name="calendar" type="UniSim::Calendar">
		<parameter name="initialDate" value="1/8/2001"/>
		<parameter name="latitude" value="55"/>
		<parameter name="timeStep" value="5"/>
		<parameter name="timeUnit" value="m"/>
	</model>

	<model name="environment" type="vg::Environment">
		<model name="records" type="UniSim::Records">
			<parameter name="fileName" value="sel_dk.txt"/>
			<parameter name="imposeInitialDateTime" value="yes"/>
		</model>
	</model>

	<model name="greenhouse">
		<model name="construction" type="vg::GreenhouseConstruction">
			<parameter name="glassType"  value="Single"/>
			<parameter name="lampType"  value="HPSL"/>
		</model>
		<model name="ventilation" type="vg::GreenhouseVentilation">
			<model name="infiltration" type="vg::AirInfiltration"/>
			<model name="windows" type="vg::WindowsVentilation"/>
		</model>
		<model name="energetics" type="vg::GreenhouseEnergetics">
			<parameter name="coverDew"  value="0"/>
			<parameter name="screenDew"  value="0"/>
			<model name="ventilationLatentEnergyBalance" type="vg::VentilationLatentEnergyBalance"/>
		</model>
		<model name="cover">
			<model name="temperature" type="vg::CoverTemperature"/>
			<model name="vapourFlux" type="vg::CoverVapourFlux"/>
			<model name="dew" type="vg::CoverDew"/>
		</model>
		<model name="floor">
			<model name="temperature" type="vg::ControlElementAsym">
				<parameter name="signal" ref="climate/temperature[value]"/>	
				<parameter name="initState"  value="20"/>
				<parameter name="rateUp" value="0.0001"/>
				<parameter name="rateDown" value="0.00001"/>
			</model>
		</model>
	</model>
	
	<model name="climate">
		<model name="temperature" type="vg::MicroclimateTemperature"/>
		<model name="humidity" type="vg::MicroclimateHumidity"/>
		<model name="CO2" type="UniSim::Fixed">
			<parameter name="parameters"  value="((value 400.))"/>
		</model>
		<model name="radiation" type="vg::IndoorsRadiation"/>
	</model>
	
	<model name="regulation">

		<model name="setpoints">
			<model name="humidity" type="vg::HumiditySetpoints"/>
			
			<model name="temperature" type="vg::TemperatureSetpoints">

				<parameter name="setMinimum" value="20"/>
				<model name="humidityIncrement" type="vg::proportionalControl">
					<parameter name="actualValue" ref="climate/humidity[moistureDeficit]"/>
					<parameter name="targetValue" ref="setpoints/humidity[minDeltaX]"/>
					<parameter name="direction" value="floor"/>
					<parameter name="gapMultiplier" value="1.5"/>
					<parameter name="pBand" value="5"/>
					<parameter name="maxSignal" value="2"/>
				</model>
			
				<parameter name="setMaximum" value="22"/>
				<model name="humidityDecrement" type="vg::ProportionalControl">
					<parameter name="actualValue" ref="climate/humidity[rh]"/>
					<parameter name="targetValue" ref="setpoints/humidity[maxRh]"/>
					<parameter name="direction" value="floor"/>
					<parameter name="pBand" value="100"/>
					<parameter name="maxSignal" value="1"/>
				</model>
			</model>
			
			<model name="CO2" type="UniSim::Fixed">
				<parameter name="parameters"  value="((minimum 400.))"/>
			</model>
		</model>
		
		<model name="ventilation" type="vg::VentilationController">
			<model name="maximum" type="vg::VentilationMax"/>

			<model name="byHumidity" type="vg::ProportionalControl">
				<parameter name="actualValue" ref="climate/humidity[rh]"/>
				<parameter name="targetValue" ref="setpoints/humidity[maxRh]"/>
				<parameter name="direction" value="floor"/>
				<parameter name="gapMultiplier" value="2"/>
				<parameter name="pBand" value="0.1"/>
				<parameter name="maxSignal" ref="../maximum[signal]"/>
			</model>

			<model name="byTemperature" type="vg::ProportionalControl">
				<parameter name="actualValue" ref="climate/temperature[value]"/>
				<parameter name="targetValue" ref="setpoints/temperature[maximum]"/>
				<parameter name="direction" value="floor"/>
				<parameter name="pBand" value="5"/>
				<parameter name="maxSignal" ref="../maximum[signal]"/>
			</model>

			<model name="byTemperatureDiff" type="vg::VentilationByTemperatureDiff"/>

			<model name="leeSideControl" type="vg::ControlElement">
				<parameter name="signal" ref="..[leeSideSignal]"/>
				<parameter name="rate" value="0.00001"/>
				<parameter name="initState" value="0"/>
			</model>
			<model name="windSideControl" type="vg::ControlElement">
				<parameter name="signal" ref="..[windSideSignal]"/>
				<parameter name="rate" ref="../leeSideControl[rate]"/>
				<parameter name="initState" value="0"/>
				</model>
		</model>

		<model name="heating">
			<model name="demand" type="vg::HeatingDemand">
			<!--
				<model name="pipe" type="vg::PidControl">
					<parameter name="actualValue" ref="climate/temperature[value]"/>
					<parameter name="targetValue" ref="setpoints/temperature[minimum]"/>
					<parameter name="initSignal" value="20"/>
					<parameter name="Kp" value="22"/>
					<parameter name="Ti" value="100"/>
					<parameter name="Td" value="0.01"/>
				</model>
				-->
				<model name="pipe" type="vg::ProportionalControl">
					<parameter name="actualValue" ref="climate/temperature[value]"/>
					<parameter name="targetValue" ref="setpoints/temperature[minimum]"/>
					<parameter name="direction" value="ceiling"/>
					<parameter name="pBand" value="0.00001"/>
					<parameter name="maxSignal" ref="..[perPipe]"/>
				</model>
			</model>
			
			<model name="pipes" type="vg::Pipes">
				<model name="lower" type= "vg::Pipe">
					<model name="control" type="vg::ControlElementAsym">
						<parameter name="signal" ref="..[signal]"/>	
						<parameter name="rateUp" value="0.001"/>
						<parameter name="rateDown" value="0.00005"/>
						<parameter name="initState"  value="20"/>
					</model>
				</model>
				<model name="upper" type= "vg::Pipe">
					<model name="control" type="vg::ControlElementAsym">
						<parameter name="signal" ref="..[signal]"/>	
						<parameter name="rateUp" value="0.001"/>
						<parameter name="rateDown" value="0.00005"/>
						<parameter name="initState"  value="20"/>
					</model>
				</model>
			</model>

		</model>
		
		<model name="CO2Supply">
			<model name="controlSignal" type="UniSim::Fixed">
				<parameter name="parameters"  value="((on false))"/>
			</model>
			<model name="state" type="UniSim::Fixed">
				<parameter name="parameters"  value="((on false))"/>
			</model>
		</model>
		<model name="light" type="vg::LightController">
			<parameter name="onDay"  value="5"/>
			<parameter name="offDay"  value="6"/>
			<parameter name="onTime"  value="14:00"/>
			<parameter name="offTime"  value="22:00"/>
			<model name="control" type="vg::ControlElement">
				<parameter name="initState"  value="0"/>
			</model>
			<model name="attributes" type="vg::LampAttributes"/>
		</model>
		<model name="screens" type="vg::Screens">
			<model name="shade" type="vg::ShadeScreenController">
				<parameter name="temperatureThreshold"  value="20"/>
				<model name="control" type="vg::ControlElement">
					<parameter name="initState"  value="0"/>
					<parameter name="rate"  value="0.00001"/>
				</model>
				<model name="temperature" type="vg::ScreenTemperature"/>
				<model name="dew" type="vg::ScreenDew"/>
				<model name="airTransmission" type="vg::ScreenTransmission">
					<parameter name="ratio"  value="0.6"/>
				</model>
				<model name="lightTransmission" type="vg::ScreenTransmission">
					<parameter name="ratio"  value="0.4"/>
				</model>
			</model>

			<model name="blackout" type="vg::BlackoutScreenController">
				<parameter name="radiationThreshold"  value="1"/>
				<model name="control" type="vg::ControlElement">
					<parameter name="initState"  value="0"/>
					<parameter name="rate" ref="../../shade/control[rate]"/>
				</model>
				<model name="temperature" type="vg::ScreenTemperature"/>
				<model name="dew" type="vg::ScreenDew"/>
				<model name="airTransmission" type="vg::ScreenTransmission">
					<parameter name="ratio"  value="0"/>
				</model>
				<model name="lightTransmission" type="vg::ScreenTransmission">
					<parameter name="ratio"  value="0"/>
				</model>
			</model>

			<model name="energy" type="vg::EnergyScreenController">
				<parameter name="radiationThreshold"  value="5"/>
				<model name="control" type="vg::ControlElement">
					<parameter name="initState"  value="0"/>
					<parameter name="rate" ref="../../shade/control[rate]"/>
				</model>
				<model name="energyBalance" type="vg::EnergyScreenBalance"/>
				<model name="temperature" type="vg::ScreenTemperature"/>
				<model name="dew" type="vg::ScreenDew"/>
				<model name="airTransmission" type="vg::ScreenTransmission">
					<parameter name="ratio"  value="0.29"/>
				</model>
				<model name="lightTransmission" type="vg::ScreenTransmission">
					<parameter name="ratio"  value="0.3"/>
				</model>
			</model>
		</model>
	</model>

	<model name="crop" type="vg::Crop">
		<model name="photosynthesis" type="UniSim::Fixed">
			<parameter name="parameters"  value="((Pgc 0.)(PgcMol 0.))"/> <!-- g CO2/m2/s and mol CO2/m2/s--> 
		</model>
		<model name="riH2O" type="vg::StomatalResistance"/>
		<model name="rbH2O" type="vg::BoundaryLayerResistance"/>
		<model name="growth" type="UniSim::Fixed">
			<parameter name="parameters"  value="((LAI 2.4))"/> 
		</model>
		<model name = "radiationAbsorption" type = "vg::CropRadiationAbsorption"/>
		<model name="layers">
			<model name="top" type="vg::CropLayer"/>
			<model name="middle" type="vg::CropLayer"/>
			<model name="bottom" type="vg::CropLayer"/>
		</model>
	</model>
	
	<!--
		Outputs
	-->
	
	<output type="plot">
		<parameter name="title" value ="Calendar"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="sinb" ref="calendar[sinb]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Shade screen"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Signal" ref="screens/shade/control[signal]"/>
		<trace label="State" ref="screens/shade/control[state]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Blackout screen"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Signal" ref="screens/Blackout/control[signal]"/>
		<trace label="State" ref="screens/Blackout/control[state]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Energy screen"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Signal" ref="screens/energy/control[signal]"/>
		<trace label="State" ref="screens/energy/control[state]"/>
	</output>
	
	<output type="plot">
		<parameter name="title" value ="Light"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Signal" ref="light/control[signal]"/>
		<trace label="State" ref="light/control[state]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Ventilation regulation (%)"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Leeside signal" ref="leeSideControl[signal]"/>
		<trace label="Leeside state" ref="leeSideControl[state]"/>
		<trace label="Windside signal" ref="windSideControl[signal]"/>
		<trace label="Windside state" ref="windSideControl[state]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Windows ventilation (m3/m2/s)"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Windows" ref="ventilation/windows[value]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Infiltration (m3/m2/s)"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Air infiltration" ref="infiltration[value]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Radiation (W/m2)"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Outdoors direct" ref="environment[directRadiation]"/>
		<trace label="Outdoors diffuse" ref="environment[diffuseRadiation]"/>
		<trace label="Indoors direct" ref="climate/radiation[direct]"/>
		<trace label="Indoors diffuse" ref="climate/radiation[diffuse]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Wind (m/s)"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Windspeed" ref="environment[windspeed]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Heating demand (W/m2)"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Total" ref="heating/demand[total]"/>
		<trace label="Per pipe" ref="heating/demand[perPipe]"/>
		<trace label="Heat flux lower" ref="heating/pipes/lower[heatFlux]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Lower pipe temperature"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="State" ref="pipes/lower/control[state]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Heat capacity (W/m2/K)"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Heat capacity" ref="greenhouse/energetics[heatCapacity]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Energy balance (W/m2)"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Energy balance" ref="greenhouse/energetics[energyBalance]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Heat sources (W/m2)"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Outdoors" ref="greenhouse/energetics[outdoorsHeat]"/>
		<trace label="Floor" ref="greenhouse/energetics[floorHeat]"/>
		<trace label="Dew" ref="greenhouse/energetics[dewHeat]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Temperature"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Outdoors" ref="environment[temperature]"/>
		<trace label="Indoors" ref="climate/temperature[value]"/>
		<trace label="Unheated" ref="greenhouse/energetics[Tunheated]"/>
		<trace label="Cover" ref="greenhouse/cover/temperature[value]"/>
		<trace label="Floor" ref="greenhouse/floor/temperature[state]"/>
		<trace label="Max sp" ref="setpoints/temperature[maximum]"/>
		<trace label="Min sp" ref="setpoints/temperature[minimum]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Relative humidity (%)"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="rh" ref="climate/humidity[rh]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="VPD (Pa)"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="vpd" ref="climate/humidity[vpd]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Delta X (g/kg)"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Delta X" ref="climate/humidity[moistureDeficit]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Resistance (m/s)"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Stomata" ref="crop/riH2O[value]"/>
		<trace label="Boundary" ref="crop/rbH2O[value]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Crop temperature (oC)"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Top" ref="crop/layers/top[temperature]"/>
		<trace label="Middle" ref="crop/layers/middle[temperature]"/>
		<trace label="Bottom" ref="crop/layers/bottom[temperature]"/>
		<trace label="Average" ref="crop[temperature]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Crop latent heat flux (J/m2/s)"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Top" ref="crop/layers/top[latentHeatFlux]"/>
		<trace label="Middle" ref="crop/layers/middle[latentHeatFlux]"/>
		<trace label="Bottom" ref="crop/layers/bottom[latentHeatFlux]"/>
		<trace label="Total" ref="crop[latentHeatFlux]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Vapour flux (kg/m2/s)"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Cover" ref="greenhouse/cover/vapourFlux[value]"/>
		<trace label="Top" ref="crop/layers/top[vapourFlux]"/>
		<trace label="Middle" ref="crop/layers/middle[vapourFlux]"/>
		<trace label="Bottom" ref="crop/layers/bottom[vapourFlux]"/>
	</output>


	<output type="plot">
		<parameter name="title" value ="Dew (g/m2/s)"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Screens" ref="regulation/screens[dew]"/>
		<trace label="Cover" ref="greenhouse/cover/dew[value]"/>
		<trace label="Top" ref="crop/layers/top[dew]"/>
		<trace label="Middle" ref="crop/layers/middle[dew]"/>
		<trace label="Bottom" ref="crop/layers/bottom[dew]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Energy consumption (MJ/m2)"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Consumption" ref="pipes[energyUsed]"/>
		<trace label="Vent loss" ref="ventilationLatentEnergyBalance[totalLoss]"/>
	</output>

	<output type="plot">
		<parameter name="title" value ="Ventilation latent energy balance (W/m2)"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="Balance" ref="ventilationLatentEnergyBalance[value]"/>
	</output>
	
	<output type="table">
		<parameter name="fileName" value ="temperature.txt"/>
		<trace label="Days" ref="steps[stepNumber]" divisor="288"/>
		<trace label="TIndoors" ref="climate/temperature[value]"/>
		<trace label="energyBalance" ref="climate/temperature[energyBalance]"/>
		<trace label="pipesHeatFlux" ref="climate/temperature[pipesHeatFlux]"/>
		<trace label="heatCapacity" ref="climate/temperature[heatCapacity]"/>
		<trace label="lower_signal" ref="pipes/lower[signal]"/>
		<trace label="lower_heatflux" ref="pipes/lower[heatflux]"/>
		<trace label="higher_signal" ref="pipes/higher[signal]"/>
		<trace label="higher_heatflux" ref="pipes/higher[heatflux]"/>
		<trace label="heating_demand" ref="heating/demand[total]"/>
	</output>

	</simulation>